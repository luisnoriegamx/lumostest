<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsychoArt Test - Edición RRHH</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #3498db; --success-color: #27ae60; --danger-color: #e74c3c; --bg-color: #ecf0f1; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Contenedor Principal */
        .main-container { background: white; width: 100%; max-width: 900px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        
        /* Header */
        header { 
            background: linear-gradient(135deg, var(--primary-color), #34495e); 
            color: white; 
            padding: 25px; 
            text-align: center; 
            position: relative; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .app-logo {
            width: 60px;
            height: 60px;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        header h1 { margin: 0; font-size: 1.8rem; letter-spacing: 1px; font-weight: 700; }
        header p { margin: 0; font-size: 0.9rem; opacity: 0.9; font-weight: 300; letter-spacing: 0.5px; }
        
        /* Indicador de Estado API */
        .api-status { position: absolute; top: 15px; right: 15px; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 20px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #95a5a6; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .status-text { font-weight: 600; font-size: 0.75rem; letter-spacing: 0.5px; text-transform: uppercase; }

        /* Área de Trabajo */
        .workspace { padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        
        /* Toolbar */
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; background: #f8f9fa; padding: 10px; border-radius: 10px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        .tool-group { display: flex; align-items: center; gap: 5px; border-right: 1px solid #ddd; padding-right: 10px; margin-right: 5px; }
        .tool-group:last-child { border-right: none; }
        
        button { border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.9rem; }
        button:hover { transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: #95a5a6; color: white; }
        .btn-warning { background-color: #f39c12; color: white; }
        
        .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; padding: 0; }
        .color-btn.active { border-color: #333; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Canvas */
        .canvas-wrapper { position: relative; border: 2px solid #bdc3c7; border-radius: 8px; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); background: white; cursor: crosshair; }
        canvas { display: block; touch-action: none; }

        /* Acciones Principales */
        .actions { width: 100%; display: flex; justify-content: center; gap: 15px; margin-top: 10px; }
        #analyzeBtn { padding: 15px 40px; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        #analyzeBtn:disabled { background-color: #bdc3c7; cursor: not-allowed; box-shadow: none; }

        /* Modales */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; max-width: 800px; width: 90%; max-height: 90vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 15px 50px rgba(0,0,0,0.2); }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-body { overflow-y: auto; flex-grow: 1; min-height: 300px; }
        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; padding-top: 15px; }

        /* Barra de Progreso */
        .progress-wrapper { width: 100%; text-align: center; }
        .progress-bar-bg { width: 100%; height: 10px; background: #ecf0f1; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s ease; }
        
        /* Iframe del reporte */
        iframe { width: 100%; height: 100%; border: none; min-height: 500px; }

        /* Responsive */
        @media (max-width: 600px) {
            .toolbar { flex-direction: column; }
            .tool-group { border-right: none; border-bottom: 1px solid #ddd; padding-bottom: 10px; width: 100%; justify-content: center; margin: 0; }
            .tool-group:last-child { border-bottom: none; }
            h1 { font-size: 1.4rem; }
            #analyzeBtn { width: 100%; }
        }
    </style>
</head>
<body>

<div class="main-container">
    <header>
        <!-- Logo SVG Integrado -->
        <svg class="app-logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="45" stroke="white" stroke-width="2" fill="none" opacity="0.5"/>
            <path d="M50 20C35 20 25 30 25 45C25 55 30 60 35 65C35 75 40 80 50 80C60 80 65 75 65 65C70 60 75 55 75 45C75 30 65 20 50 20Z" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M50 20V40" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M50 40L35 30" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M50 40L65 30" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <circle cx="40" cy="45" r="3" fill="white"/>
            <circle cx="60" cy="45" r="3" fill="white"/>
            <path d="M50 60C45 60 40 65 35 65" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M50 60C55 60 60 65 65 65" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
        
        <h1>PsychoArt Analytics</h1>
        <p>Plataforma de Evaluación Proyectiva para RRHH</p>
        
        <div class="api-status">
            <div id="statusDot" class="status-dot"></div>
            <span id="statusText" class="status-text">Conectando...</span>
        </div>
    </header>

    <div class="workspace">
        <div class="toolbar">
            <div class="tool-group">
                <button class="color-btn active" style="background: black;" onclick="setColor('black')" title="Lápiz Negro"></button>
                <button class="color-btn" style="background: #e74c3c;" onclick="setColor('#e74c3c')" title="Lápiz Rojo"></button>
                <button class="color-btn" style="background: #3498db;" onclick="setColor('#3498db')" title="Lápiz Azul"></button>
            </div>
            <div class="tool-group">
                <label for="brushSize" style="font-size: 0.9rem;">Grosor:</label>
                <input type="range" id="brushSize" min="1" max="20" value="3" oninput="setSize(this.value)">
            </div>
            <div class="tool-group">
                <button class="btn-secondary" onclick="toggleEraser()" id="eraserBtn">Borrador</button>
                <button class="btn-danger" onclick="clearCanvas()">Limpiar Todo</button>
            </div>
        </div>

        <div class="canvas-wrapper" id="canvasContainer">
            <canvas id="drawingCanvas"></canvas>
        </div>

        <div class="actions">
            <button class="btn-secondary" onclick="downloadImage()">Descargar Imagen</button>
            <button id="analyzeBtn" class="btn-primary" onclick="startAnalysis()" disabled>Analizar Dibujo</button>
        </div>
    </div>
</div>

<!-- Modal de Progreso -->
<div id="progressModal" class="modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <h3>Analizando Personalidad</h3>
        <p id="progressText">Iniciando...</p>
        <div class="progress-wrapper">
            <div class="progress-bar-bg"><div id="progressBar" class="progress-bar-fill"></div></div>
        </div>
        <p style="font-size: 0.8rem; color: #7f8c8d;">Por favor no cierres esta ventana.</p>
    </div>
</div>

<!-- Modal de Reporte -->
<div id="reportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin:0; color: var(--primary-color);">Informe de Resultados</h2>
            <button onclick="closeModal('reportModal')" style="background:none; color:#333; font-size:1.5rem;">&times;</button>
        </div>
        <div class="modal-body" id="reportContent">
            <!-- El iframe se inyectará aquí -->
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('reportModal')">Cerrar</button>
            <button class="btn-success" onclick="downloadPDF()">Guardar PDF</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURACIÓN CRÍTICA ---
    const DEFAULT_API_KEY = "AIzaSyBXm2UPWGu_6pnmpiDvbEQQQBHA9sxOoXE";
    let GEMINI_API_KEY = DEFAULT_API_KEY; 
    // -----------------------------

    // Variables de Estado
    let canvas, ctx, isDrawing = false, lastX = 0, lastY = 0;
    let currentColor = 'black';
    let currentSize = 3;
    let isEraser = false;
    let activeModel = null; // Modelo validado

    // Modelos a probar: Prioridad al 2.5 como solicitado
    const MODELS_TO_TEST = [
        "gemini-2.5-flash",
        "gemini-1.5-flash",
        "gemini-1.5-pro",
        "gemini-pro"
    ];

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
        initCanvas();
        
        // FORZAR LA NUEVA CLAVE
        GEMINI_API_KEY = DEFAULT_API_KEY;
        localStorage.setItem('custom_gemini_key', GEMINI_API_KEY);

        validateAPIConnection();
    });

    // --- Lógica del Canvas (Dibujo) ---
    function initCanvas() {
        canvas = document.getElementById('drawingCanvas');
        ctx = canvas.getContext('2d');
        const container = document.getElementById('canvasContainer');
        canvas.width = 800; 
        canvas.height = 450;
        canvas.style.width = '100%';
        canvas.style.height = 'auto';

        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('mouseout', endDraw);
        canvas.addEventListener('touchstart', (e) => startDraw(e.touches[0]));
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
        canvas.addEventListener('touchend', endDraw);
    }

    function getPos(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: (clientX - rect.left) * (canvas.width / rect.width),
            y: (clientY - rect.top) * (canvas.height / rect.height)
        };
    }

    function startDraw(e) {
        isDrawing = true;
        const pos = getPos(e.clientX, e.clientY);
        lastX = pos.x;
        lastY = pos.y;
    }

    function draw(e) {
        if (!isDrawing) return;
        const pos = getPos(e.clientX, e.clientY);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = isEraser ? 'white' : currentColor;
        ctx.lineWidth = isEraser ? currentSize * 3 : currentSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
        lastX = pos.x;
        lastY = pos.y;
    }

    function endDraw() { isDrawing = false; }
    
    function setColor(color) {
        isEraser = false;
        currentColor = color;
        document.getElementById('eraserBtn').classList.remove('btn-primary');
        document.getElementById('eraserBtn').classList.add('btn-secondary');
        document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function setSize(size) { currentSize = size; }
    
    function toggleEraser() {
        isEraser = !isEraser;
        const btn = document.getElementById('eraserBtn');
        if (isEraser) {
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
            btn.innerText = "Borrador (Activo)";
        } else {
            btn.classList.add('btn-secondary');
            btn.classList.remove('btn-primary');
            btn.innerText = "Borrador";
        }
    }

    function clearCanvas() {
        if(confirm('¿Borrar todo el dibujo?')) {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = 'dibujo_candidato.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    // --- Gestión de API Keys y Validación ---

    async function validateAPIConnection() {
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const analyzeBtn = document.getElementById('analyzeBtn');

        statusText.innerText = "Verificando...";
        statusDot.style.background = "#f1c40f"; // Amarillo

        let lastErrorMsg = "";

        // Intentar encontrar un modelo que funcione
        for (const model of MODELS_TO_TEST) {
            try {
                // Petición mínima ("ping")
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                const body = { contents: [{ parts: [{ text: "Hi" }] }] };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    activeModel = model;
                    console.log("Modelo activo confirmado:", activeModel);
                    statusDot.style.background = "#27ae60"; // Verde
                    statusText.innerText = `Online (${model})`;
                    statusText.title = "Conexión exitosa";
                    analyzeBtn.disabled = false;
                    return; // ¡Éxito!
                } else {
                    const errData = await response.json();
                    const errMsg = errData.error ? errData.error.message : response.statusText;
                    console.warn(`Modelo ${model} falló:`, errMsg);
                    lastErrorMsg = errMsg;
                }
            } catch (e) {
                console.warn(`Error de red con ${model}`, e);
                lastErrorMsg = e.message;
            }
        }

        // Si llegamos aquí, NINGÚN modelo funcionó
        statusDot.style.background = "#e74c3c"; // Rojo
        statusText.innerText = "Error API";
        analyzeBtn.disabled = true;

        alert("⚠️ No se pudo conectar con Google AI.\n\nError: " + lastErrorMsg);
    }

    // --- Lógica de Análisis ---

    async function startAnalysis() {
        if (!activeModel) {
            validateAPIConnection();
            return;
        }
        
        document.getElementById('progressModal').classList.add('active');
        updateProgress(10, "Procesando imagen...");

        const base64Image = canvas.toDataURL('image/png').split(',')[1];
        
        try {
            updateProgress(30, "Enviando a Gemini IA...");
            const analysisHTML = await callGemini(base64Image);
            
            updateProgress(90, "Generando reporte...");
            const reportContent = document.getElementById('reportContent');
            
            reportContent.innerHTML = '';
            const iframe = document.createElement('iframe');
            iframe.srcdoc = analysisHTML;
            reportContent.appendChild(iframe);

            setTimeout(() => {
                document.getElementById('progressModal').classList.remove('active');
                document.getElementById('reportModal').classList.add('active');
                updateProgress(0, "");
            }, 1000);

        } catch (error) {
            document.getElementById('progressModal').classList.remove('active');
            alert("Error durante el análisis:\n" + error.message);
        }
    }

    function updateProgress(percent, text) {
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').innerText = text;
    }

    async function callGemini(base64Image) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${activeModel}:generateContent?key=${GEMINI_API_KEY}`;
        
        const prompt = `
            Actúa como un experto Psicólogo Organizacional (Senior).
            Analiza el siguiente dibujo proyectivo para un proceso de selección de personal.
            
            IMPORTANTE: Genera SOLAMENTE código HTML válido para ser insertado en un <body>.
            No uses bloques de código markdown (\`\`\`).
            
            Estructura HTML requerida:
            <div style="font-family: sans-serif; padding: 20px;">
                <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db;">Informe Psico-Laboral</h2>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #2980b9;">1. Perfil General</h3>
                    <p>[Descripción del perfil]</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #2980b9;">2. Competencias Clave</h3>
                    <ul style="line-height: 1.6;">
                        <li><strong>Liderazgo:</strong> [Análisis]</li>
                        <li><strong>Trabajo en Equipo:</strong> [Análisis]</li>
                        <li><strong>Tolerancia a la Presión:</strong> [Análisis]</li>
                    </ul>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #c0392b;">3. Áreas de Oportunidad</h3>
                    <p>[Posibles riesgos o debilidades]</p>
                </div>

                <div style="background-color: #ecf0f1; padding: 15px; border-radius: 5px;">
                    <strong>Conclusión:</strong> [Recomendación final: Recomendable / Con Reservas / No Recomendable]
                </div>
            </div>
        `;

        const body = {
            contents: [{
                parts: [
                    { text: prompt },
                    { inline_data: { mime_type: "image/png", data: base64Image } }
                ]
            }]
        };

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error ? errData.error.message : response.statusText);
        }

        const data = await response.json();
        let text = data.candidates[0].content.parts[0].text;
        
        // Limpieza de seguridad
        text = text.replace(/```html/g, '').replace(/```/g, '');
        return text;
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function downloadPDF() {
        const iframe = document.querySelector('#reportContent iframe');
        if (iframe && iframe.contentWindow) {
            const element = iframe.contentWindow.document.body;
            const opt = {
                margin: 10,
                filename: 'Reporte_Psicometrico.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
        } else {
            alert("No hay reporte generado para descargar.");
        }
    }
</script>

</body>
</html>
